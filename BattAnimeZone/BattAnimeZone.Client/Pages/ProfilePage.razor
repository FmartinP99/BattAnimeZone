@inject NavigationManager navManager
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JSRuntime
@using BattAnimeZone.Client.Components
@using BattAnimeZone.Shared.Models.AnimeDTOs
@rendermode InteractiveWebAssembly
@page "/Profile/{UserName}"
<link rel="stylesheet" href="/ProfilePage.css?version=0.3" />

@if (!loaded)
{
    <LoadingComponent></LoadingComponent>
}else{


    <RadzenRow id="mainContainerRow">


        <RadzenColumn id="outerLeftColumn">

        <div id="UserNameDiv">
            <span id="userNameSpan">@UserName's profile</span>
        </div>

        <div id="animeCountContainerDiv">

                <div id="completedDiv" class="textContainerDiv">
                    <p class="centered-text">Completed</p>

                    <p class="centered-text">
                        ( @(OwnAnimes.ContainsKey("completed") ? @OwnAnimes["completed"].Count() : 0) )
                    </p>
                </div>


                <div id="watchingDiv" class="textContainerDiv">
                    <p class="centered-text">Watching</p>

                    <p class="centered-text">
                        ( @(OwnAnimes.ContainsKey("watching") ? @OwnAnimes["watching"].Count() : 0) )
                    </p>
                </div>



                <div id="onholdDiv" class="textContainerDiv">
                    <p class="centered-text">On hold</p>

                    <p class="centered-text">
                        ( @(OwnAnimes.ContainsKey("on hold") ? @OwnAnimes["on hold"].Count() : 0) )
                    </p>
                </div>




                <div id="plannedDiv" class="textContainerDiv">
                    <p class="centered-text">Planned</p>

                    <p class="centered-text">
                        ( @(OwnAnimes.ContainsKey("planned") ? @OwnAnimes["planned"].Count() : 0) )
                    </p>
                </div>




                <div id="droppedDiv" class="textContainerDiv">
                    <p class="centered-text">Dropped</p>

                    <p class="centered-text">
                        ( @(OwnAnimes.ContainsKey("dropped") ? @OwnAnimes["dropped"].Count() : 0) )
                    </p>
                </div>




                <div id="favoritesDiv" class="textContainerDiv">
                    <p class="centered-text">Favorites</p>

                    <p class="centered-text">
                        ( @( OwnAnimes.ContainsKey("favorites") ? @OwnAnimes["favorites"].Count() : 0 ) )
                    </p>
                </div>

            </div>


        </RadzenColumn>

         <RadzenColumn id="outerRightColumn">
            <RadzenTabs Change=@OnChange TabPosition=TabPosition.Top RenderMode="TabRenderMode.Client">
                <Tabs>
                    @foreach(string state in PossibleStates)
                    {
                        <RadzenTabsItem Text="@state" class="tabsItemClass">
                            <RadzenDataList PageSize="10" WrapItems="true" AllowPaging="true" Data="@OwnAnimes[state]" TItem="AnimeProfilePageDTO">
                                <Template Context="anime">
                                    <RadzenRow class="animeRow" @onclick=@(() => NavigateTo(anime.Mal_id))>
                                        <RadzenColumn class="imageCol">
                                            <RadzenImage class="imageDiv" Path="@anime.ImageLargeWebpUrl"></RadzenImage>
                                        </RadzenColumn>

                                        <RadzenColumn class="notImageCol">

                                            <RadzenRow class="animeCardUpperRow">

                                                <div class="titleCol">
                                                     @anime.Title
                                                </div>

                                            </RadzenRow>

                                            <RadzenRow class="animeCardLowerRow">

                                                <div class="attributesCol">
                                                    Type: <br> @anime.MediaType
                                                </div>

                                                <div class="attributesCol">
                                                    Episodes: <br> @anime.Episodes
                                                </div>

                                                <div class="attributesCol">
                                                    Score: <br> @anime.Score
                                                </div>

                                                <div class="attributesCol">
                                                    Popularity: <br> @anime.Popularity
                                                </div>

                                                <div Sclass="attributesCol">
                                                    Year: <br> @anime.Year
                                                </div>

                                                <div class="attributesCol">
                                                    Status: <br> @anime.Status
                                                </div>

                                                <div class="attributesCol">
                                                    Rated at: <br> @anime.UserRating/10
                                                </div>

                                                <div class="attributesCol">
                                                    Favorite: <br> @FavoriteToString(anime.UserFavorite)
                                                </div>

                                            </RadzenRow>

                                        </RadzenColumn>


                                    </RadzenRow>
                                </Template>
                            </RadzenDataList>
                        </RadzenTabsItem>
                    }

                </Tabs>
            </RadzenTabs>
        </RadzenColumn>


    </RadzenRow>




    @code {

    bool loaded = false;

    [Parameter]
    public string? UserName { get; set; }

    Dictionary<string, List<AnimeProfilePageDTO>?> OwnAnimes = new Dictionary<string, List<AnimeProfilePageDTO>?>();
    string selected_tab = "Finished";
    HttpClient httpClient;

    List<string> PossibleStates = new List<string>(){ "completed", "watching", "on hold", "planned", "dropped", "favorites" };

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            loaded = true;
            try
            {
                httpClient = HttpClientFactory.CreateClient("AuthenticatedClient");
                var response = await httpClient.GetAsync($"{navManager.BaseUri}api/AccountController/GetProfile/{UserName}");
                if (response.IsSuccessStatusCode)
                {
                    List<AnimeProfilePageDTO>? queried_animes = await response.Content.ReadFromJsonAsync<List<AnimeProfilePageDTO>?>();

                    foreach(var state in PossibleStates)
                    {
                        OwnAnimes[state] = new List<AnimeProfilePageDTO>();
                    }

                    if (queried_animes != null)
                    {
                        foreach (var anime in queried_animes)
                        {

                            if (OwnAnimes[anime.UserStatus] != null)
                                OwnAnimes[anime.UserStatus].Add(anime);
                            else                        
                                OwnAnimes[anime.UserStatus] = new List<AnimeProfilePageDTO> { anime };

                            if (OwnAnimes["favorites"] != null && anime.UserFavorite == true)
                                OwnAnimes["favorites"].Add(anime);
                            else if (OwnAnimes["favorites"] == null && anime.UserFavorite == true)
                            {
                                OwnAnimes["favorites"] = new List<AnimeProfilePageDTO> { anime };
                            }
                        }
                    }
                }
                else
                {
                    await JSRuntime.InvokeVoidAsync("console.error", $"{response.StatusCode}\n {response.ReasonPhrase}");

                }
            }
            catch (Exception e)
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"{e.Message}");
            }
            finally
            {
                StateHasChanged();
            }
        }
    }

    string FavoriteToString(bool favorite)
    {
        return favorite == true ? "Yes" : "No";
    }

    void OnChange(int index)
    {
        Console.WriteLine($"selected {index}");
    }

    protected void NavigateTo(int mal_id)
    {

        navManager.NavigateTo($"/anime/{mal_id}");
    }

}

}
